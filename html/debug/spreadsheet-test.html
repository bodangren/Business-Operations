<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spreadsheet Simulator Test Suite | Debug</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/textbook.css">
    <link rel="stylesheet" href="../assets/css/callouts.css">
    
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .debug-section {
            margin: 40px 0;
            padding: 20px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        
        .test-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .error-log {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .success-log {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .component-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px;
        }
        
        .status-loaded { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <h1>🔧 Spreadsheet Simulator Test Suite</h1>
            <p>Comprehensive testing and debugging for all spreadsheet simulator functionality</p>
        </div>
    </header>

    <main id="main-content" class="main-content">
        <div class="container">
            <div class="content-wrapper">
                <div class="main-content-area">
                    
                    <!-- Debug Information Panel -->
                    <div class="debug-panel">
                        <h2>🚨 Debug Information</h2>
                        <div id="system-info"></div>
                        <div id="component-status"></div>
                        <div id="error-console"></div>
                        
                        <h3>Quick Test Actions</h3>
                        <button class="test-button" onclick="runAllTests()">Run All Tests</button>
                        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
                        <button class="test-button" onclick="exportDebugInfo()">Export Debug Info</button>
                        <button class="test-button" onclick="testSafeFormulaEvaluator()">Test SafeFormulaEvaluator</button>
                        <button class="test-button" onclick="testFormulas()">Test Formulas</button>
                        <button class="test-button" onclick="testKeyboardNav()">Test Keyboard Navigation</button>
                        <button class="test-button" onclick="inspectSpreadsheetCode()">Inspect Spreadsheet Code</button>
                    </div>

                    <!-- Test Section 1: Basic Preset -->
                    <div class="debug-section">
                        <h2>Test 1: Basic Preset</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test standard 15x8 spreadsheet with basic functionality<br>
                            <strong>Expected:</strong> Functional grid with formula evaluation and cell selection
                        </div>
                        
                        <div class="test-container">
                            <h3>Basic Spreadsheet (15x8)</h3>
                            <div class="spreadsheet-simulator-container" data-preset="basic" id="test-basic"></div>
                            
                            <div class="debug-panel">
                                <h4>Test Actions for Basic Preset:</h4>
                                <button class="test-button" onclick="testBasicOperations('test-basic')">Test Basic Operations</button>
                                <button class="test-button" onclick="testFormulaCalculation('test-basic')">Test Formula Calculation</button>
                                <button class="test-button" onclick="loadTestData('test-basic', 'basic')">Load Test Data</button>
                                <div id="basic-test-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 2: Ledger Preset -->
                    <div class="debug-section">
                        <h2>Test 2: Ledger Preset</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test accounting ledger format with pre-defined columns<br>
                            <strong>Expected:</strong> Date, Description, Account, Debit, Credit, Balance columns with proper formatting
                        </div>
                        
                        <div class="test-container">
                            <h3>Ledger Spreadsheet</h3>
                            <div class="spreadsheet-simulator-container" data-preset="ledger" id="test-ledger"></div>
                            
                            <div class="debug-panel">
                                <h4>Test Actions for Ledger Preset:</h4>
                                <button class="test-button" onclick="testLedgerFormatting('test-ledger')">Test Ledger Formatting</button>
                                <button class="test-button" onclick="testAccountingFormulas('test-ledger')">Test Accounting Formulas</button>
                                <button class="test-button" onclick="loadTestData('test-ledger', 'ledger')">Load Ledger Test Data</button>
                                <div id="ledger-test-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 3: Trial Balance Preset -->
                    <div class="debug-section">
                        <h2>Test 3: Trial Balance Preset</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test trial balance format with account categorization<br>
                            <strong>Expected:</strong> Account Name, Type, Debit, Credit columns with balance verification
                        </div>
                        
                        <div class="test-container">
                            <h3>Trial Balance Spreadsheet</h3>
                            <div class="spreadsheet-simulator-container" data-preset="trialBalance" id="test-trial"></div>
                            
                            <div class="debug-panel">
                                <h4>Test Actions for Trial Balance Preset:</h4>
                                <button class="test-button" onclick="testTrialBalanceLogic('test-trial')">Test Balance Logic</button>
                                <button class="test-button" onclick="testAccountTypes('test-trial')">Test Account Types</button>
                                <button class="test-button" onclick="loadTestData('test-trial', 'trialBalance')">Load Trial Balance Data</button>
                                <div id="trial-test-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 4: Calculator Preset -->
                    <div class="debug-section">
                        <h2>Test 4: Calculator Preset</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test compact 10x4 grid optimized for calculations<br>
                            <strong>Expected:</strong> Smaller grid with enhanced formula functionality
                        </div>
                        
                        <div class="test-container">
                            <h3>Calculator Spreadsheet (10x4)</h3>
                            <div class="spreadsheet-simulator-container" data-preset="calculator" id="test-calculator"></div>
                            
                            <div class="debug-panel">
                                <h4>Test Actions for Calculator Preset:</h4>
                                <button class="test-button" onclick="testCalculatorFunctions('test-calculator')">Test Calculator Functions</button>
                                <button class="test-button" onclick="testMathOperations('test-calculator')">Test Math Operations</button>
                                <button class="test-button" onclick="loadTestData('test-calculator', 'calculator')">Load Calculator Data</button>
                                <div id="calculator-test-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 5: Custom Configuration -->
                    <div class="debug-section">
                        <h2>Test 5: Custom Configuration</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test custom row/column configuration and options<br>
                            <strong>Expected:</strong> 25x12 grid with editable settings
                        </div>
                        
                        <div class="test-container">
                            <h3>Custom Spreadsheet (25x12)</h3>
                            <div class="spreadsheet-simulator-container" 
                                 data-rows="25" 
                                 data-cols="12" 
                                 data-allow-edit="true"
                                 id="test-custom"></div>
                            
                            <div class="debug-panel">
                                <h4>Test Actions for Custom Configuration:</h4>
                                <button class="test-button" onclick="testCustomDimensions('test-custom')">Test Custom Dimensions</button>
                                <button class="test-button" onclick="testEditPermissions('test-custom')">Test Edit Permissions</button>
                                <button class="test-button" onclick="loadTestData('test-custom', 'custom')">Load Custom Test Data</button>
                                <div id="custom-test-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Comprehensive Testing Section -->
                    <div class="debug-section">
                        <h2>🧪 Comprehensive Test Results</h2>
                        <div id="comprehensive-results"></div>
                        
                        <div class="debug-panel">
                            <h3>Performance Metrics</h3>
                            <div id="performance-metrics"></div>
                            
                            <h3>Browser Compatibility</h3>
                            <div id="browser-info"></div>
                            
                            <h3>Memory Usage</h3>
                            <div id="memory-info"></div>
                        </div>
                    </div>

                    <!-- Error Log Section -->
                    <div class="debug-section">
                        <h2>🐛 Error Log & Console Output</h2>
                        <div id="error-log" class="error-log">No errors logged yet...</div>
                        
                        <h3>Test Data Export</h3>
                        <textarea id="debug-export" rows="10" cols="100" readonly 
                                  placeholder="Debug information will appear here for copy/paste into chat"></textarea>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="../assets/js/safe-formula-evaluator.js"></script>
    <script src="../assets/js/gamification.js"></script>
    <script src="../assets/js/spreadsheet-simulator.js"></script>
    <script src="../assets/js/exercises.js"></script>
    
    <script>
        // Debug logging system
        let debugLog = [];
        let testResults = {};
        
        // Override console methods to capture output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };
        
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            logDebug('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            logDebug('ERROR', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            logDebug('WARN', args.join(' '));
        };
        
        function logDebug(type, message) {
            const timestamp = new Date().toISOString();
            debugLog.push({type, message, timestamp});
            updateErrorLog();
        }
        
        function updateErrorLog() {
            const errorDiv = document.getElementById('error-log');
            if (debugLog.length === 0) {
                errorDiv.textContent = 'No errors logged yet...';
                return;
            }
            
            errorDiv.innerHTML = debugLog.map(entry => 
                `[${entry.timestamp}] ${entry.type}: ${entry.message}`
            ).join('\n');
        }
        
        // System information collection
        function collectSystemInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenResolution: `${screen.width}x${screen.height}`,
                windowSize: `${window.innerWidth}x${window.innerHeight}`,
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('system-info').innerHTML = `
                <h3>System Information</h3>
                <strong>Browser:</strong> ${info.userAgent}<br>
                <strong>Platform:</strong> ${info.platform}<br>
                <strong>Language:</strong> ${info.language}<br>
                <strong>Screen:</strong> ${info.screenResolution}<br>
                <strong>Window:</strong> ${info.windowSize}<br>
                <strong>Online:</strong> ${info.onLine}<br>
                <strong>Test Time:</strong> ${info.timestamp}
            `;
            
            return info;
        }
        
        // Component status checking
        function checkComponentStatus() {
            const components = [
                {name: 'SafeFormulaEvaluator', check: () => window.SafeFormulaEvaluator},
                {name: 'Spreadsheet Simulator', check: () => window.SpreadsheetSimulator},
                {name: 'Gamification', check: () => window.Gamification},
                {name: 'Exercises', check: () => window.Exercises}
            ];
            
            const statusDiv = document.getElementById('component-status');
            let statusHTML = '<h3>Component Status</h3>';
            
            components.forEach(comp => {
                const isLoaded = comp.check();
                const statusClass = isLoaded ? 'status-loaded' : 'status-error';
                const statusText = isLoaded ? 'LOADED' : 'ERROR';
                statusHTML += `<span class="component-status ${statusClass}">${comp.name}: ${statusText}</span>`;
                
                // Add detailed info for SafeFormulaEvaluator
                if (comp.name === 'SafeFormulaEvaluator' && isLoaded) {
                    try {
                        const evaluator = new window.SafeFormulaEvaluator();
                        const testResult = evaluator.evaluate('=2+3');
                        statusHTML += `<br><small>SafeFormulaEvaluator test (2+3): ${testResult}</small>`;
                    } catch (error) {
                        statusHTML += `<br><small style="color:red;">SafeFormulaEvaluator test failed: ${error.message}</small>`;
                    }
                }
                
                // Add detailed info for spreadsheet instances
                if (comp.name === 'Spreadsheet Simulator' && isLoaded) {
                    const containers = document.querySelectorAll('.spreadsheet-simulator-container');
                    statusHTML += `<br><small>Found ${containers.length} spreadsheet containers</small>`;
                    
                    containers.forEach((container, index) => {
                        if (container.spreadsheetSimulator) {
                            const simulator = container.spreadsheetSimulator;
                            const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(simulator));
                            statusHTML += `<br><small>Container ${index}: ${methods.length} methods available</small>`;
                            
                            // Check specific methods
                            const criticalMethods = ['setData', 'getData', 'setFormula', 'selectCell'];
                            criticalMethods.forEach(method => {
                                const hasMethod = typeof simulator[method] === 'function';
                                const methodStatus = hasMethod ? '✓' : '✗';
                                statusHTML += `<br><small>&nbsp;&nbsp;${methodStatus} ${method}</small>`;
                            });
                        } else {
                            statusHTML += `<br><small style="color:red;">Container ${index}: No simulator instance</small>`;
                        }
                    });
                }
            });
            
            statusDiv.innerHTML = statusHTML;
        }
        
        // Test functions for different presets
        function testBasicOperations(containerId) {
            const container = document.getElementById(containerId);
            const simulator = container.spreadsheetSimulator;
            const results = [];
            
            try {
                // Test cell selection
                if (simulator && simulator.selectCell) {
                    simulator.selectCell('A1');
                    results.push('✓ Cell selection works');
                } else {
                    results.push('✗ Cell selection failed');
                }
                
                // Test data entry
                if (simulator && simulator.setData) {
                    simulator.setData({'A1': 'Test', 'B1': 123});
                    results.push('✓ Data entry works');
                } else {
                    results.push('✗ Data entry failed');
                }
                
                // Test data retrieval
                if (simulator && simulator.getData) {
                    const data = simulator.getData();
                    results.push(`✓ Data retrieval works: ${JSON.stringify(data)}`);
                } else {
                    results.push('✗ Data retrieval failed');
                }
                
            } catch (error) {
                results.push(`✗ Error in basic operations: ${error.message}`);
                logDebug('ERROR', `Basic operations test failed: ${error.message}`);
            }
            
            document.getElementById('basic-test-results').innerHTML = results.join('<br>');
            testResults[containerId + '_basic'] = results;
        }
        
        function testFormulaCalculation(containerId) {
            const container = document.getElementById(containerId);
            const simulator = container.spreadsheetSimulator;
            const results = [];
            
            logDebug('LOG', `Starting detailed formula test for ${containerId}`);
            
            try {
                // Check if simulator exists
                if (!simulator) {
                    results.push('✗ No simulator instance found');
                    return;
                }
                
                // Check if SafeFormulaEvaluator is available globally
                if (!window.SafeFormulaEvaluator) {
                    results.push('✗ SafeFormulaEvaluator not available globally');
                } else {
                    results.push('✓ SafeFormulaEvaluator available globally');
                    
                    // Test SafeFormulaEvaluator directly
                    try {
                        const evaluator = new window.SafeFormulaEvaluator();
                        const directTest = evaluator.evaluate('=2+3');
                        results.push(`✓ Direct SafeFormulaEvaluator test: 2+3 = ${directTest}`);
                    } catch (evalError) {
                        results.push(`✗ Direct SafeFormulaEvaluator failed: ${evalError.message}`);
                    }
                }
                
                // Check simulator methods
                const hasSetData = typeof simulator.setData === 'function';
                const hasSetFormula = typeof simulator.setFormula === 'function';
                const hasGetData = typeof simulator.getData === 'function';
                
                results.push(`${hasSetData ? '✓' : '✗'} setData method available`);
                results.push(`${hasSetFormula ? '✓' : '✗'} setFormula method available`);
                results.push(`${hasGetData ? '✓' : '✗'} getData method available`);
                
                if (!hasSetData || !hasSetFormula || !hasGetData) {
                    results.push('✗ Required methods missing, cannot test formulas');
                    return;
                }
                
                // Test basic data setting
                logDebug('LOG', 'Setting test data: A1=10, A2=20');
                simulator.setData({'A1': 10, 'A2': 20});
                const initialData = simulator.getData();
                results.push(`✓ Data set successfully: A1=${initialData.A1}, A2=${initialData.A2}`);
                
                // Test basic addition formula
                logDebug('LOG', 'Testing formula: =A1+A2');
                try {
                    simulator.setFormula('A3', '=A1+A2');
                    const dataAfterFormula = simulator.getData();
                    
                    results.push(`Formula result A3: ${dataAfterFormula.A3} (type: ${typeof dataAfterFormula.A3})`);
                    
                    if (dataAfterFormula.A3 === 30) {
                        results.push('✓ Basic addition formula works correctly');
                    } else if (dataAfterFormula.A3 === '#ERROR!') {
                        results.push('✗ Formula returned #ERROR! - formula evaluation failed');
                        
                        // Check if simulator has access to SafeFormulaEvaluator
                        if (simulator.formulaEvaluator) {
                            results.push('✓ Simulator has formulaEvaluator property');
                        } else {
                            results.push('✗ Simulator missing formulaEvaluator property');
                        }
                        
                        // Check if simulator has SafeFormulaEvaluator in its context
                        if (simulator.safeFormulaEvaluator) {
                            results.push('✓ Simulator has safeFormulaEvaluator property');
                        } else {
                            results.push('✗ Simulator missing safeFormulaEvaluator property');
                        }
                        
                    } else {
                        results.push(`✗ Addition failed: expected 30, got ${dataAfterFormula.A3}`);
                    }
                } catch (formulaError) {
                    results.push(`✗ setFormula threw error: ${formulaError.message}`);
                    logDebug('ERROR', `setFormula error: ${formulaError.stack}`);
                }
                
                // Test SUM function
                logDebug('LOG', 'Testing SUM function: =SUM(A1:A2)');
                try {
                    simulator.setFormula('A4', '=SUM(A1:A2)');
                    const sumData = simulator.getData();
                    results.push(`SUM result A4: ${sumData.A4} (type: ${typeof sumData.A4})`);
                    
                    if (sumData.A4 === 30) {
                        results.push('✓ SUM function works correctly');
                    } else if (sumData.A4 === '#ERROR!') {
                        results.push('✗ SUM returned #ERROR! - function evaluation failed');
                    } else {
                        results.push(`✗ SUM failed: expected 30, got ${sumData.A4}`);
                    }
                } catch (sumError) {
                    results.push(`✗ SUM formula threw error: ${sumError.message}`);
                    logDebug('ERROR', `SUM formula error: ${sumError.stack}`);
                }
                
                // Inspect simulator's internal state
                logDebug('LOG', 'Inspecting simulator internal state...');
                const simulatorProps = Object.getOwnPropertyNames(simulator);
                results.push(`Simulator properties: ${simulatorProps.join(', ')}`);
                
                // Check if simulator has data
                if (simulator.data) {
                    results.push(`✓ Simulator has data property with ${Object.keys(simulator.data).length} entries`);
                } else {
                    results.push('✗ Simulator missing data property');
                }
                
                // Check if simulator has formula evaluation capability
                if (simulator.evaluateFormula) {
                    results.push('✓ Simulator has evaluateFormula method');
                    try {
                        const directEval = simulator.evaluateFormula('2+3'); // Remove = prefix, evaluateFormula adds it
                        results.push(`Direct evaluateFormula test: ${directEval}`);
                    } catch (directError) {
                        results.push(`✗ Direct evaluateFormula failed: ${directError.message}`);
                    }
                } else {
                    results.push('✗ Simulator missing evaluateFormula method');
                }
                
            } catch (error) {
                results.push(`✗ Error in formula calculation: ${error.message}`);
                results.push(`Error stack: ${error.stack}`);
                logDebug('ERROR', `Formula calculation test failed: ${error.message}`);
                logDebug('ERROR', `Stack trace: ${error.stack}`);
            }
            
            const resultDiv = document.getElementById('basic-test-results');
            resultDiv.innerHTML += '<br><strong>Detailed Formula Tests:</strong><br>' + results.join('<br>');
            testResults[containerId + '_formulas'] = results;
        }
        
        function loadTestData(containerId, presetType) {
            const container = document.getElementById(containerId);
            const simulator = container.spreadsheetSimulator;
            
            const testDataSets = {
                basic: {
                    'A1': 'Revenue', 'B1': 15000, 'C1': 'January',
                    'A2': 'Expenses', 'B2': 8000, 'C2': 'February',
                    'A3': 'Profit', 'B3': '=B1-B2', 'C3': 'March'
                },
                ledger: {
                    'A1': 'Date', 'B1': 'Description', 'C1': 'Account', 'D1': 'Debit', 'E1': 'Credit', 'F1': 'Balance',
                    'A2': '2024-01-01', 'B2': 'Initial Investment', 'C2': 'Cash', 'D2': 5000, 'E2': '', 'F2': 5000,
                    'A3': '2024-01-02', 'B3': 'Office Supplies', 'C3': 'Supplies', 'D3': 150, 'E3': '', 'F3': '=F2+D3-E3'
                },
                trialBalance: {
                    'A1': 'Account', 'B1': 'Type', 'C1': 'Debit', 'D1': 'Credit',
                    'A2': 'Cash', 'B2': 'Asset', 'C2': 5000, 'D2': '',
                    'A3': 'Accounts Payable', 'B3': 'Liability', 'C3': '', 'D3': 1500
                },
                calculator: {
                    'A1': 'Price', 'B1': 25,
                    'A2': 'Quantity', 'B2': 100,
                    'A3': 'Total', 'B3': '=A1*A2',
                    'A4': 'Tax Rate', 'B4': 0.08
                },
                custom: {
                    'A1': 'Custom Test', 'B1': 'Data Set',
                    'A2': 'Large Grid', 'B2': 'Testing'
                }
            };
            
            try {
                if (simulator && simulator.setData) {
                    simulator.setData(testDataSets[presetType] || testDataSets.basic);
                    logDebug('LOG', `Test data loaded for ${presetType} preset`);
                } else {
                    logDebug('ERROR', `Cannot load test data - simulator not available for ${containerId}`);
                }
            } catch (error) {
                logDebug('ERROR', `Failed to load test data: ${error.message}`);
            }
        }
        
        // Comprehensive test runner
        function runAllTests() {
            logDebug('LOG', 'Starting comprehensive test suite...');
            
            const containers = ['test-basic', 'test-ledger', 'test-trial', 'test-calculator', 'test-custom'];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container && container.spreadsheetSimulator) {
                    testBasicOperations(containerId);
                    setTimeout(() => testFormulaCalculation(containerId), 100);
                } else {
                    logDebug('ERROR', `Container ${containerId} not found or simulator not initialized`);
                }
            });
            
            setTimeout(generateComprehensiveReport, 500);
        }
        
        function generateComprehensiveReport() {
            const results = document.getElementById('comprehensive-results');
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => 
                result.some(r => r.startsWith('✓'))
            ).length;
            
            results.innerHTML = `
                <div class="success-log">
                    <h3>Test Summary</h3>
                    <strong>Total Test Suites:</strong> ${totalTests}<br>
                    <strong>Passed:</strong> ${passedTests}<br>
                    <strong>Failed:</strong> ${totalTests - passedTests}<br>
                    <strong>Success Rate:</strong> ${totalTests > 0 ? Math.round((passedTests/totalTests)*100) : 0}%
                </div>
            `;
        }
        
        function exportDebugInfo() {
            const exportData = {
                systemInfo: collectSystemInfo(),
                componentStatus: checkComponentStatus(),
                testResults: testResults,
                debugLog: debugLog,
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('debug-export').value = JSON.stringify(exportData, null, 2);
        }
        
        function clearLogs() {
            debugLog = [];
            testResults = {};
            updateErrorLog();
            document.getElementById('debug-export').value = '';
            
            // Clear all test result divs
            ['basic-test-results', 'ledger-test-results', 'trial-test-results', 
             'calculator-test-results', 'custom-test-results', 'comprehensive-results'].forEach(id => {
                const div = document.getElementById(id);
                if (div) div.innerHTML = '';
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('LOG', 'Debug page loaded, initializing...');
            collectSystemInfo();
            
            // Wait for components to load, then check status
            setTimeout(() => {
                checkComponentStatus();
                logDebug('LOG', 'Initial component status check completed');
            }, 1000);
        });
        
        // Additional test functions for specific presets
        function testLedgerFormatting(containerId) {
            logDebug('LOG', `Testing ledger formatting for ${containerId}`);
            // Implementation for ledger-specific tests
        }
        
        function testAccountingFormulas(containerId) {
            logDebug('LOG', `Testing accounting formulas for ${containerId}`);
            // Implementation for accounting formula tests
        }
        
        function testTrialBalanceLogic(containerId) {
            logDebug('LOG', `Testing trial balance logic for ${containerId}`);
            // Implementation for trial balance tests
        }
        
        function testAccountTypes(containerId) {
            logDebug('LOG', `Testing account types for ${containerId}`);
            // Implementation for account type validation
        }
        
        function testCalculatorFunctions(containerId) {
            logDebug('LOG', `Testing calculator functions for ${containerId}`);
            // Implementation for calculator-specific tests
        }
        
        function testMathOperations(containerId) {
            logDebug('LOG', `Testing math operations for ${containerId}`);
            // Implementation for math operation tests
        }
        
        function testCustomDimensions(containerId) {
            logDebug('LOG', `Testing custom dimensions for ${containerId}`);
            // Implementation for custom dimension tests
        }
        
        function testEditPermissions(containerId) {
            logDebug('LOG', `Testing edit permissions for ${containerId}`);
            // Implementation for edit permission tests
        }
        
        function testFormulas() {
            logDebug('LOG', 'Running comprehensive formula tests...');
            // Implementation for comprehensive formula testing
        }
        
        function testKeyboardNav() {
            logDebug('LOG', 'Testing keyboard navigation...');
            // Implementation for keyboard navigation tests
        }
        
        // Dedicated SafeFormulaEvaluator testing
        function testSafeFormulaEvaluator() {
            logDebug('LOG', 'Starting comprehensive SafeFormulaEvaluator tests...');
            const results = [];
            
            if (!window.SafeFormulaEvaluator) {
                results.push('✗ SafeFormulaEvaluator not available');
                document.getElementById('error-log').innerHTML += '\n[CRITICAL] SafeFormulaEvaluator not loaded!';
                return;
            }
            
            try {
                const evaluator = new window.SafeFormulaEvaluator();
                results.push('✓ SafeFormulaEvaluator instance created');
                
                // Test basic arithmetic
                const tests = [
                    {formula: '=2+3', expected: 5},
                    {formula: '=10-4', expected: 6},
                    {formula: '=3*7', expected: 21},
                    {formula: '=15/3', expected: 5},
                    {formula: '=(2+3)*4', expected: 20},
                    {formula: '=2*3+4*5', expected: 26}
                ];
                
                tests.forEach(test => {
                    try {
                        const result = evaluator.evaluate(test.formula);
                        if (result === test.expected) {
                            results.push(`✓ ${test.formula} = ${result} (correct)`);
                        } else {
                            results.push(`✗ ${test.formula} = ${result} (expected ${test.expected})`);
                        }
                    } catch (error) {
                        results.push(`✗ ${test.formula} threw error: ${error.message}`);
                    }
                });
                
                // Test security (should all fail safely)
                const maliciousTests = [
                    '=alert("test")',
                    '=window.location',
                    '=eval("1+1")',
                    '=Function("return 1")()'
                ];
                
                maliciousTests.forEach(test => {
                    try {
                        const result = evaluator.evaluate(test);
                        if (result === '#ERROR!') {
                            results.push(`✓ Security test: ${test} correctly blocked`);
                        } else {
                            results.push(`✗ Security FAILURE: ${test} returned ${result}`);
                        }
                    } catch (error) {
                        results.push(`✓ Security test: ${test} correctly threw error`);
                    }
                });
                
                // Test with mock spreadsheet context
                const mockData = {
                    'A1': 10,
                    'A2': 20,
                    'B1': 5
                };
                
                const mockContext = {
                    data: mockData,
                    calculateRangeSum: function(start, end) {
                        return this.data[start] + this.data[end]; // Simplified
                    }
                };
                
                evaluator.setSpreadsheetContext(mockContext);
                results.push('✓ Mock spreadsheet context set');
                
                // Test cell references (these might not work without full context implementation)
                try {
                    const cellRefResult = evaluator.evaluate('=A1+A2');
                    results.push(`Cell reference test A1+A2: ${cellRefResult}`);
                } catch (cellError) {
                    results.push(`Cell reference test failed: ${cellError.message}`);
                }
                
            } catch (error) {
                results.push(`✗ SafeFormulaEvaluator test failed: ${error.message}`);
                results.push(`Stack trace: ${error.stack}`);
            }
            
            // Display results in a dedicated area
            const resultsHTML = `
                <div class="debug-panel">
                    <h3>SafeFormulaEvaluator Test Results</h3>
                    ${results.join('<br>')}
                </div>
            `;
            
            document.getElementById('error-log').innerHTML += '\n\n' + resultsHTML;
            testResults.safeFormulaEvaluator = results;
        }
        
        // Inspect the actual spreadsheet-simulator.js code and structure
        function inspectSpreadsheetCode() {
            logDebug('LOG', 'Inspecting spreadsheet simulator implementation...');
            const results = [];
            
            // Check if SpreadsheetSimulator constructor exists
            if (window.SpreadsheetSimulator) {
                results.push('✓ SpreadsheetSimulator constructor available');
                
                // Get the constructor's prototype methods
                const prototype = window.SpreadsheetSimulator.prototype;
                const methods = Object.getOwnPropertyNames(prototype);
                results.push(`Available methods: ${methods.join(', ')}`);
                
                // Check for specific critical methods
                const criticalMethods = [
                    'setData', 'getData', 'setFormula', 'selectCell', 
                    'evaluateFormula', 'createTable', 'initializePreset'
                ];
                
                criticalMethods.forEach(method => {
                    if (typeof prototype[method] === 'function') {
                        results.push(`✓ Method ${method} exists`);
                        
                        // Try to get the function source for debugging
                        try {
                            const funcSource = prototype[method].toString();
                            const lines = funcSource.split('\n').length;
                            results.push(`&nbsp;&nbsp;${method} has ${lines} lines of code`);
                            
                            // Check if it mentions SafeFormulaEvaluator
                            if (funcSource.includes('SafeFormulaEvaluator')) {
                                results.push(`&nbsp;&nbsp;✓ ${method} references SafeFormulaEvaluator`);
                            } else if (method === 'setFormula' || method === 'evaluateFormula') {
                                results.push(`&nbsp;&nbsp;✗ ${method} does NOT reference SafeFormulaEvaluator`);
                            }
                        } catch (sourceError) {
                            results.push(`&nbsp;&nbsp;Could not inspect ${method} source`);
                        }
                    } else {
                        results.push(`✗ Method ${method} missing`);
                    }
                });
                
                // Try to create a test instance
                try {
                    const testContainer = document.createElement('div');
                    const testInstance = new window.SpreadsheetSimulator(testContainer, {});
                    results.push('✓ Test instance created successfully');
                    
                    // Check instance properties
                    const instanceProps = Object.getOwnPropertyNames(testInstance);
                    results.push(`Instance properties: ${instanceProps.join(', ')}`);
                    
                    // Check for formula evaluator property
                    if (testInstance.formulaEvaluator) {
                        results.push('✓ Instance has formulaEvaluator property');
                        results.push(`&nbsp;&nbsp;Type: ${typeof testInstance.formulaEvaluator}`);
                    } else {
                        results.push('✗ Instance missing formulaEvaluator property');
                    }
                    
                    if (testInstance.safeFormulaEvaluator) {
                        results.push('✓ Instance has safeFormulaEvaluator property');
                    } else {
                        results.push('✗ Instance missing safeFormulaEvaluator property');
                    }
                    
                } catch (instanceError) {
                    results.push(`✗ Failed to create test instance: ${instanceError.message}`);
                }
                
            } else {
                results.push('✗ SpreadsheetSimulator constructor not available');
            }
            
            // Check for global references to SafeFormulaEvaluator
            if (window.SafeFormulaEvaluator) {
                results.push('✓ SafeFormulaEvaluator available globally');
                
                // Check if any existing spreadsheet instances have it
                const containers = document.querySelectorAll('.spreadsheet-simulator-container');
                containers.forEach((container, index) => {
                    if (container.spreadsheetSimulator) {
                        const hasEvaluator = container.spreadsheetSimulator.formulaEvaluator || 
                                           container.spreadsheetSimulator.safeFormulaEvaluator;
                        results.push(`Container ${index}: ${hasEvaluator ? 'HAS' : 'MISSING'} formula evaluator`);
                    }
                });
            } else {
                results.push('✗ SafeFormulaEvaluator NOT available globally');
            }
            
            // Display results
            const resultsHTML = `
                <div class="debug-panel">
                    <h3>Spreadsheet Code Inspection</h3>
                    ${results.join('<br>')}
                </div>
            `;
            
            document.getElementById('error-log').innerHTML += '\n\n' + resultsHTML;
            testResults.codeInspection = results;
        }
    </script>
</body>
</html>