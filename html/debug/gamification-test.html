<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamification System Test Suite | Debug</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/textbook.css">
    <link rel="stylesheet" href="../assets/css/callouts.css">
    
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .debug-section {
            margin: 40px 0;
            padding: 20px;
            border-left: 4px solid #fd7e14;
            background: #f8f9fa;
        }
        
        .test-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            position: relative;
            z-index: 1;
        }
        
        .error-log {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success-log {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-button {
            background: #fd7e14;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            z-index: 10;
        }
        
        .test-button:hover {
            background: #e8681b;
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .component-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px;
        }
        
        .status-loaded { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        .gamification-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .gamification-test-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            position: relative;
            z-index: 1;
        }
        
        .test-result {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }

        .gamification-container {
            min-height: 400px;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 6px;
            background: #fafafa;
            position: relative;
            z-index: 2;
        }
        
        /* Ensure test buttons appear above gamification elements */
        .debug-panel {
            position: relative;
            z-index: 15;
        }
        
        .gamification-controls {
            position: relative;
            z-index: 10;
        }

        .achievement-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 12px;
        }

        .level-progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .level-fill {
            background: linear-gradient(to right, #fd7e14, #f8b500);
            height: 100%;
            transition: width 0.3s ease;
        }

        .points-display {
            font-size: 18px;
            font-weight: bold;
            color: #fd7e14;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <h1>üèÜ Gamification System Test Suite</h1>
            <p>Comprehensive testing and debugging for points, achievements, levels, and progress tracking</p>
        </div>
    </header>

    <main id="main-content" class="main-content">
        <div class="container">
            <div class="content-wrapper">
                <div class="main-content-area">
                    
                    <!-- Debug Information Panel -->
                    <div class="debug-panel">
                        <h2>üö® Debug Information</h2>
                        <div id="system-info"></div>
                        <div id="component-status"></div>
                        <div id="error-console"></div>
                        
                        <h3>Quick Test Actions</h3>
                        <button class="test-button" onclick="runAllGamificationTests()">Run All Tests</button>
                        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
                        <button class="test-button" onclick="generateTestSummary()">Generate Test Summary</button>
                        <button class="test-button" onclick="testGamificationSystem()">Test Gamification System</button>
                        <button class="test-button" onclick="testPointsSystem()">Test Points System</button>
                        <button class="test-button" onclick="testAchievements()">Test Achievements</button>
                        <button class="test-button" onclick="resetGamificationData()">Reset All Data</button>
                    </div>

                    <!-- Test Section 1: Gamification System -->
                    <div class="debug-section">
                        <h2>Test 1: Gamification System Loading</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test gamification.js loading and initialization<br>
                            <strong>Expected:</strong> Gamification namespace loads with points, levels, achievements, and progress tracking
                        </div>
                        
                        <div class="test-container">
                            <h3>System Status</h3>
                            <div id="gamification-status"></div>
                            
                            <div class="debug-panel">
                                <h4>System Test Actions:</h4>
                                <button class="test-button" onclick="testGamificationLoading()">Check Gamification Loading</button>
                                <button class="test-button" onclick="testGamificationAPI()">Test Gamification API</button>
                                <button class="test-button" onclick="testLocalStorage()">Test Local Storage</button>
                                <button class="test-button" onclick="testEventHandlers()">Test Event Handlers</button>
                                
                                <div id="gamification-test-results" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 2: Points System -->
                    <div class="debug-section">
                        <h2>Test 2: Points & Scoring System</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test points allocation, scoring, and point-based rewards<br>
                            <strong>Expected:</strong> Points earned for activities, proper scoring calculations, point persistence
                        </div>
                        
                        <div class="gamification-test-grid">
                            <div class="gamification-test-item">
                                <h4>Points System Test</h4>
                                <div class="gamification-container" id="points-test">
                                    <div class="points-display" id="current-points">0 Points</div>
                                    <div class="test-actions">
                                        <button onclick="awardTestPoints(10)" class="btn btn-sm">+10 Points</button>
                                        <button onclick="awardTestPoints(50)" class="btn btn-sm">+50 Points</button>
                                        <button onclick="awardTestPoints(100)" class="btn btn-sm">+100 Points</button>
                                        <button onclick="deductPoints(25)" class="btn btn-sm">-25 Points</button>
                                    </div>
                                </div>
                                <button class="test-button" onclick="testPointsAwarding()">Test Points Awarding</button>
                                <div id="points-results" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 3: Levels & Progress -->
                    <div class="debug-section">
                        <h2>Test 3: Levels & Progress Tracking</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test level progression, experience points, and progress visualization<br>
                            <strong>Expected:</strong> Level-up mechanics, progress bars, experience tracking, level rewards
                        </div>
                        
                        <div class="gamification-test-grid">
                            <div class="gamification-test-item">
                                <h4>Levels System Test</h4>
                                <div class="gamification-container" id="levels-test">
                                    <div class="level-info">
                                        <h5>Level <span id="current-level">1</span></h5>
                                        <div class="level-progress">
                                            <div class="level-fill" id="level-progress" style="width: 0%"></div>
                                        </div>
                                        <p>XP: <span id="current-xp">0</span> / <span id="next-level-xp">100</span></p>
                                    </div>
                                    <div class="test-actions">
                                        <button onclick="gainTestExperience(25)" class="btn btn-sm">+25 XP</button>
                                        <button onclick="gainTestExperience(50)" class="btn btn-sm">+50 XP</button>
                                        <button onclick="gainTestExperience(100)" class="btn btn-sm">+100 XP</button>
                                    </div>
                                </div>
                                <button class="test-button" onclick="testLevelProgression()">Test Level Progression</button>
                                <div id="levels-results" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 4: Achievements System -->
                    <div class="debug-section">
                        <h2>Test 4: Achievements & Badges</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test achievement unlocking, badge system, and milestone tracking<br>
                            <strong>Expected:</strong> Achievement triggers, badge displays, progress toward achievements
                        </div>
                        
                        <div class="gamification-test-grid">
                            <div class="gamification-test-item">
                                <h4>Achievements System Test</h4>
                                <div class="gamification-container" id="achievements-test">
                                    <div class="achievements-display">
                                        <h5>Unlocked Achievements</h5>
                                        <div id="achievements-list">
                                            <p>No achievements unlocked yet...</p>
                                        </div>
                                    </div>
                                    <div class="test-actions">
                                        <button onclick="triggerAchievement('first-points')" class="btn btn-sm">First Points</button>
                                        <button onclick="triggerAchievement('level-up')" class="btn btn-sm">Level Up</button>
                                        <button onclick="triggerAchievement('exercise-master')" class="btn btn-sm">Exercise Master</button>
                                        <button onclick="triggerAchievement('simulation-expert')" class="btn btn-sm">Simulation Expert</button>
                                    </div>
                                </div>
                                <button class="test-button" onclick="testAchievementSystem()">Test Achievement System</button>
                                <div id="achievements-results" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 5: Progress Tracking -->
                    <div class="debug-section">
                        <h2>Test 5: Progress Tracking & Analytics</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test student progress tracking, analytics, and performance metrics<br>
                            <strong>Expected:</strong> Progress persistence, completion tracking, performance analytics
                        </div>
                        
                        <div class="test-container">
                            <h3>Progress Tracking Testing</h3>
                            
                            <div class="debug-panel">
                                <h4>Progress Test Actions:</h4>
                                <button class="test-button" onclick="testProgressTracking()">Test Progress Tracking</button>
                                <button class="test-button" onclick="testCompletionTracking()">Test Completion Tracking</button>
                                <button class="test-button" onclick="testPerformanceMetrics()">Test Performance Metrics</button>
                                <button class="test-button" onclick="testDataPersistence()">Test Data Persistence</button>
                                <button class="test-button" onclick="testProgressAnalytics()">Test Progress Analytics</button>
                                
                                <div id="progress-test-results" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 6: Integration Tests -->
                    <div class="debug-section">
                        <h2>Test 6: Integration & Performance Tests</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test gamification integration with other systems and performance<br>
                            <strong>Expected:</strong> Proper integration with exercises, simulations, and calculators
                        </div>
                        
                        <div class="test-container">
                            <h3>Integration & Performance Testing</h3>
                            
                            <div class="debug-panel">
                                <h4>Integration Test Actions:</h4>
                                <button class="test-button" onclick="testExerciseIntegration()">Test Exercise Integration</button>
                                <button class="test-button" onclick="testSimulationIntegration()">Test Simulation Integration</button>
                                <button class="test-button" onclick="testCalculatorIntegration()">Test Calculator Integration</button>
                                <button class="test-button" onclick="testNotificationSystem()">Test Notification System</button>
                                <button class="test-button" onclick="testPerformanceImpact()">Test Performance Impact</button>
                                <button class="test-button" onclick="testMobileCompatibility()">Test Mobile Compatibility</button>
                                
                                <div id="integration-test-results" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Results Summary -->
                    <div class="debug-section">
                        <h2>üìä Test Results Summary</h2>
                        
                        <div class="debug-panel">
                            <h4>Test Results (Copy/Paste Ready)</h4>
                            <textarea id="test-results-output" style="width: 100%; height: 200px; font-family: monospace; font-size: 12px;" readonly placeholder="Click 'Generate Test Summary' to see results here..."></textarea>
                        </div>
                        
                        <div class="debug-panel">
                            <h4>Full Debug Data (JSON)</h4>
                            <textarea id="debug-data-output" style="width: 100%; height: 300px; font-family: monospace; font-size: 11px;" readonly placeholder="Click 'Generate Full Debug Data' to see JSON data here..."></textarea>
                        </div>
                        
                        <button class="test-button" onclick="generateFullDebugData()">Generate Full Debug Data</button>
                    </div>

                    <!-- Error Log Section -->
                    <div class="debug-section">
                        <h2>üêõ Error Log & Console Output</h2>
                        <div id="error-log" class="error-log">No errors logged yet...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="../assets/js/gamification.js"></script>
    
    <script>
        // Debug logging system
        let debugLog = [];
        let testResults = {};
        let performanceMetrics = {};
        let localGamificationData = {
            points: 0,
            level: 1,
            xp: 0,
            achievements: []
        };

        function logDebug(type, message) {
            const timestamp = new Date().toISOString();
            debugLog.push({ type, message, timestamp });
            
            const errorLog = document.getElementById('error-log');
            if (errorLog) {
                errorLog.textContent = debugLog.map(log => 
                    `[${log.timestamp}] ${log.type}: ${log.message}`
                ).join('\\n');
                errorLog.scrollTop = errorLog.scrollHeight;
            }
        }

        function clearLogs() {
            debugLog = [];
            document.getElementById('error-log').textContent = 'Logs cleared...';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('LOG', 'Gamification debug page loaded, initializing...');
            updateSystemInfo();
            updateComponentStatus();
            
            setTimeout(() => {
                logDebug('LOG', 'Initial setup completed');
            }, 2000);
        });

        function updateSystemInfo() {
            const systemInfo = document.getElementById('system-info');
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: `${screen.width}x${screen.height}`,
                windowSize: `${window.innerWidth}x${window.innerHeight}`,
                memoryInfo: navigator.deviceMemory ? `${navigator.deviceMemory}GB` : 'Not available',
                timestamp: new Date().toISOString()
            };
            
            systemInfo.innerHTML = `
                <h4>System Information</h4>
                <small>
                    Browser: ${info.userAgent}<br>
                    Platform: ${info.platform}<br>
                    Language: ${info.language}<br>
                    Screen: ${info.screenResolution}<br>
                    Window: ${info.windowSize}<br>
                    Memory: ${info.memoryInfo}<br>
                    Timestamp: ${info.timestamp}
                </small>
            `;
        }

        function updateComponentStatus() {
            const statusDiv = document.getElementById('component-status');
            let statusHTML = '<h4>Component Status</h4>';
            
            // Check Gamification components
            const components = [
                { name: 'Gamification', obj: window.Gamification },
                { name: 'GamificationData', obj: window.GamificationData },
                { name: 'awardPoints', obj: window.awardPoints },
                { name: 'addExperience', obj: window.addExperience },
                { name: 'unlockAchievement', obj: window.unlockAchievement },
                { name: 'updateProgress', obj: window.updateProgress },
                { name: 'getPlayerLevel', obj: window.getPlayerLevel },
                { name: 'showNotification', obj: window.showNotification }
            ];
            
            components.forEach(component => {
                const status = component.obj ? 'LOADED' : 'NOT LOADED';
                const statusClass = component.obj ? 'status-loaded' : 'status-error';
                statusHTML += `<span class="component-status ${statusClass}">${component.name}: ${status}</span><br>`;
            });
            
            statusDiv.innerHTML = statusHTML;
        }
        
        // Gamification system tests
        function testGamificationLoading() {
            const results = [];
            
            if (window.Gamification) {
                results.push('‚úì Gamification namespace loaded');
                
                const methods = [
                    'awardPoints',
                    'addExperience', 
                    'unlockAchievement',
                    'updateProgress',
                    'getPlayerLevel',
                    'showNotification'
                ];
                
                methods.forEach(method => {
                    if (typeof window.Gamification[method] === 'function') {
                        results.push(`‚úì ${method} method available`);
                    } else if (typeof window[method] === 'function') {
                        results.push(`‚úì ${method} global function available`);
                    } else {
                        results.push(`‚úó ${method} method missing`);
                    }
                });
                
            } else {
                results.push('‚úó Gamification not loaded');
            }
            
            document.getElementById('gamification-test-results').innerHTML = results.join('<br>');
            testResults.gamification_loading = results;
        }
        
        function testGamificationAPI() {
            const results = [];
            
            // Test basic API methods
            const apiTests = [
                {name: 'Points System', test: () => typeof window.awardPoints === 'function'},
                {name: 'Experience System', test: () => typeof window.addExperience === 'function'},
                {name: 'Achievement System', test: () => typeof window.unlockAchievement === 'function'},
                {name: 'Progress Tracking', test: () => typeof window.updateProgress === 'function'},
                {name: 'Level System', test: () => typeof window.getPlayerLevel === 'function'},
                {name: 'Notification System', test: () => typeof window.showNotification === 'function'}
            ];
            
            apiTests.forEach(test => {
                try {
                    if (test.test()) {
                        results.push(`‚úì ${test.name} API available`);
                    } else {
                        results.push(`‚úó ${test.name} API not available`);
                    }
                } catch (error) {
                    results.push(`‚úó ${test.name} API error: ${error.message}`);
                }
            });
            
            document.getElementById('gamification-test-results').innerHTML += '<br><strong>API Tests:</strong><br>' + results.join('<br>');
            testResults.gamification_api = results;
        }
        
        function testLocalStorage() {
            const results = [];
            
            try {
                // Test localStorage for gamification data
                if (typeof Storage !== 'undefined') {
                    results.push('‚úì localStorage API available');
                    
                    // Test writing gamification data
                    const testKey = 'gamification-test';
                    const testData = { points: 100, level: 2, achievements: ['test'] };
                    localStorage.setItem(testKey, JSON.stringify(testData));
                    
                    // Test reading gamification data
                    const retrievedData = JSON.parse(localStorage.getItem(testKey));
                    if (retrievedData && retrievedData.points === 100) {
                        results.push('‚úì Gamification data persistence works');
                    } else {
                        results.push('‚úó Gamification data persistence failed');
                    }
                    
                    // Clean up
                    localStorage.removeItem(testKey);
                    results.push('‚úì Gamification data cleanup successful');
                    
                } else {
                    results.push('‚úó localStorage not available');
                }
                
            } catch (error) {
                results.push(`‚úó localStorage test failed: ${error.message}`);
            }
            
            document.getElementById('gamification-test-results').innerHTML += '<br><strong>Storage Tests:</strong><br>' + results.join('<br>');
            testResults.local_storage = results;
        }
        
        function testEventHandlers() {
            const results = [];
            
            // Test event handling capabilities
            const eventTests = [
                {name: 'Custom Events', test: () => typeof CustomEvent !== 'undefined'},
                {name: 'Event Listeners', test: () => typeof document.addEventListener === 'function'},
                {name: 'Event Dispatching', test: () => typeof document.dispatchEvent === 'function'}
            ];
            
            eventTests.forEach(test => {
                try {
                    if (test.test()) {
                        results.push(`‚úì ${test.name} supported`);
                    } else {
                        results.push(`‚úó ${test.name} not supported`);
                    }
                } catch (error) {
                    results.push(`‚úó ${test.name} error: ${error.message}`);
                }
            });
            
            document.getElementById('gamification-test-results').innerHTML += '<br><strong>Event Handler Tests:</strong><br>' + results.join('<br>');
            testResults.event_handlers = results;
        }

        // Points system testing
        function awardTestPoints(points) {
            localGamificationData.points += points;
            document.getElementById('current-points').textContent = `${localGamificationData.points} Points`;
            
            // Test global points function if available
            if (typeof window.awardPoints === 'function') {
                try {
                    window.awardPoints(points, 'Test points');
                } catch (error) {
                    logDebug('ERROR', `Points awarding failed: ${error.message}`);
                }
            }
        }

        function deductPoints(points) {
            localGamificationData.points = Math.max(0, localGamificationData.points - points);
            document.getElementById('current-points').textContent = `${localGamificationData.points} Points`;
        }

        function testPointsAwarding() {
            const results = [];
            
            try {
                const initialPoints = localGamificationData.points;
                awardTestPoints(50);
                
                if (localGamificationData.points === initialPoints + 50) {
                    results.push('‚úì Local points awarding works correctly');
                } else {
                    results.push('‚úó Local points awarding failed');
                }
                
                // Test global points function directly
                if (typeof window.awardPoints === 'function') {
                    try {
                        window.awardPoints(25, 'Direct test');
                        results.push('‚úì Global points function executed successfully');
                    } catch (error) {
                        results.push(`‚úó Global points function failed: ${error.message}`);
                    }
                }
                
                deductPoints(25);
                if (localGamificationData.points === initialPoints + 25) {
                    results.push('‚úì Points deduction works correctly');
                } else {
                    results.push('‚úó Points deduction failed');
                }
                
            } catch (error) {
                results.push(`‚úó Points testing failed: ${error.message}`);
            }
            
            document.getElementById('points-results').innerHTML = results.join('<br>');
            testResults.points_awarding = results;
        }

        // Level system testing
        function gainTestExperience(xp) {
            localGamificationData.xp += xp;
            
            // Simple level calculation (100 XP per level)
            const newLevel = Math.floor(localGamificationData.xp / 100) + 1;
            if (newLevel > localGamificationData.level) {
                localGamificationData.level = newLevel;
                document.getElementById('current-level').textContent = localGamificationData.level;
            }
            
            const currentLevelXP = (localGamificationData.level - 1) * 100;
            const nextLevelXP = localGamificationData.level * 100;
            const progressXP = localGamificationData.xp - currentLevelXP;
            const progressPercent = (progressXP / 100) * 100;
            
            document.getElementById('current-xp').textContent = localGamificationData.xp;
            document.getElementById('next-level-xp').textContent = nextLevelXP;
            document.getElementById('level-progress').style.width = `${progressPercent}%`;
            
            // Test global experience function if available
            if (typeof window.addExperience === 'function') {
                try {
                    window.addExperience(xp, 'Test experience');
                } catch (error) {
                    logDebug('ERROR', `Experience gain failed: ${error.message}`);
                }
            }
        }

        function testLevelProgression() {
            const results = [];
            
            try {
                const initialLevel = localGamificationData.level;
                const initialXP = localGamificationData.xp;
                
                gainTestExperience(150);
                
                if (localGamificationData.xp === initialXP + 150) {
                    results.push('‚úì Local experience gaining works correctly');
                } else {
                    results.push('‚úó Local experience gaining failed');
                }
                
                if (localGamificationData.level > initialLevel) {
                    results.push('‚úì Local level progression works correctly');
                } else {
                    results.push('‚ö† Local level progression may need more XP');
                }
                
                // Test global level functions
                if (typeof window.getPlayerLevel === 'function') {
                    try {
                        const playerLevel = window.getPlayerLevel();
                        results.push(`‚úì Global level function works: Level ${playerLevel.level}, XP ${playerLevel.xp}`);
                    } catch (error) {
                        results.push(`‚úó Global level function failed: ${error.message}`);
                    }
                }
                
            } catch (error) {
                results.push(`‚úó Level testing failed: ${error.message}`);
            }
            
            document.getElementById('levels-results').innerHTML = results.join('<br>');
            testResults.level_progression = results;
        }

        // Achievement system testing
        function triggerAchievement(achievementId) {
            const achievements = {
                'first-points': { name: 'First Points', description: 'Earned your first points!' },
                'level-up': { name: 'Level Up', description: 'Reached a new level!' },
                'exercise-master': { name: 'Exercise Master', description: 'Completed 10 exercises!' },
                'simulation-expert': { name: 'Simulation Expert', description: 'Mastered all simulations!' }
            };
            
            const achievement = achievements[achievementId];
            if (achievement && !localGamificationData.achievements.includes(achievementId)) {
                localGamificationData.achievements.push(achievementId);
                
                const achievementsList = document.getElementById('achievements-list');
                if (localGamificationData.achievements.length === 1) {
                    achievementsList.innerHTML = '';
                }
                
                const badge = document.createElement('span');
                badge.className = 'achievement-badge';
                badge.textContent = achievement.name;
                badge.title = achievement.description;
                achievementsList.appendChild(badge);
                
                // Test global achievement function if available
                if (typeof window.unlockAchievement === 'function') {
                    try {
                        window.unlockAchievement(achievementId, achievement.name);
                    } catch (error) {
                        logDebug('ERROR', `Achievement unlock failed: ${error.message}`);
                    }
                }
            }
        }

        function testAchievementSystem() {
            const results = [];
            
            try {
                const initialCount = localGamificationData.achievements.length;
                
                // Try to unlock a new achievement that doesn't exist yet
                triggerAchievement('level-up');
                
                if (localGamificationData.achievements.length === initialCount + 1) {
                    results.push('‚úì New achievement unlocking works correctly');
                } else {
                    results.push(`‚úó Achievement unlocking failed (expected ${initialCount + 1}, got ${localGamificationData.achievements.length})`);
                }
                
                // Test duplicate achievement - try to unlock the same one again
                const countAfterFirst = localGamificationData.achievements.length;
                triggerAchievement('level-up');
                if (localGamificationData.achievements.length === countAfterFirst) {
                    results.push('‚úì Duplicate achievement prevention works');
                } else {
                    results.push('‚úó Duplicate achievement prevention failed');
                }
                
                // Test global achievement function
                if (typeof window.unlockAchievement === 'function') {
                    try {
                        window.unlockAchievement('exercise-master', 'Exercise Master');
                        results.push('‚úì Global achievement function executed successfully');
                    } catch (error) {
                        results.push(`‚úó Global achievement function failed: ${error.message}`);
                    }
                }
                
            } catch (error) {
                results.push(`‚úó Achievement testing failed: ${error.message}`);
            }
            
            document.getElementById('achievements-results').innerHTML = results.join('<br>');
            testResults.achievement_system = results;
        }

        // Comprehensive test functions
        function runAllGamificationTests() {
            logDebug('LOG', 'Starting comprehensive gamification test suite...');
            
            setTimeout(() => testGamificationLoading(), 100);
            setTimeout(() => testGamificationAPI(), 200);
            setTimeout(() => testLocalStorage(), 300);
            setTimeout(() => testEventHandlers(), 400);
            setTimeout(() => testPointsAwarding(), 500);
            setTimeout(() => testLevelProgression(), 600);
            setTimeout(() => testAchievementSystem(), 700);
            setTimeout(() => testProgressTracking(), 800);
        }

        function testGamificationSystem() {
            testGamificationLoading();
            setTimeout(() => testGamificationAPI(), 100);
            setTimeout(() => testLocalStorage(), 200);
            setTimeout(() => testEventHandlers(), 300);
        }

        function testPointsSystem() {
            testPointsAwarding();
        }

        function testAchievements() {
            testAchievementSystem();
        }

        function resetGamificationData() {
            localGamificationData = {
                points: 0,
                level: 1,
                xp: 0,
                achievements: []
            };
            
            document.getElementById('current-points').textContent = '0 Points';
            document.getElementById('current-level').textContent = '1';
            document.getElementById('current-xp').textContent = '0';
            document.getElementById('next-level-xp').textContent = '100';
            document.getElementById('level-progress').style.width = '0%';
            document.getElementById('achievements-list').innerHTML = '<p>No achievements unlocked yet...</p>';
            
            logDebug('LOG', 'All gamification data reset');
        }

        // Additional test functions
        function testProgressTracking() {
            const results = ['Progress tracking testing started...'];
            document.getElementById('progress-test-results').innerHTML = results.join('<br>');
        }

        function testCompletionTracking() {
            const results = ['Completion tracking testing started...'];
            document.getElementById('progress-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        function testPerformanceMetrics() {
            const results = ['Performance metrics testing started...'];
            document.getElementById('progress-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        function testDataPersistence() {
            const results = ['Data persistence testing started...'];
            document.getElementById('progress-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        function testProgressAnalytics() {
            const results = ['Progress analytics testing started...'];
            document.getElementById('progress-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        function testExerciseIntegration() {
            const results = ['Exercise integration testing started...'];
            document.getElementById('integration-test-results').innerHTML = results.join('<br>');
        }

        function testSimulationIntegration() {
            const results = ['Simulation integration testing started...'];
            document.getElementById('integration-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        function testCalculatorIntegration() {
            const results = ['Calculator integration testing started...'];
            document.getElementById('integration-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        function testNotificationSystem() {
            const results = ['Notification system testing started...'];
            document.getElementById('integration-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        function testPerformanceImpact() {
            const results = [];
            if (performance.memory) {
                results.push(`Used JS Heap: ${(performance.memory.usedJSHeapSize / 1048576).toFixed(2)}MB`);
                results.push(`Total JS Heap: ${(performance.memory.totalJSHeapSize / 1048576).toFixed(2)}MB`);
                results.push(`Heap Limit: ${(performance.memory.jsHeapSizeLimit / 1048576).toFixed(2)}MB`);
            } else {
                results.push('Memory info not available');
            }
            document.getElementById('integration-test-results').innerHTML += '<br><strong>Performance Impact:</strong><br>' + results.join('<br>');
        }

        function testMobileCompatibility() {
            const results = ['Mobile compatibility testing started...'];
            document.getElementById('integration-test-results').innerHTML += '<br>' + results.join('<br>');
        }

        // Display functions for test results
        function generateTestSummary() {
            const summary = [];
            summary.push('=== GAMIFICATION SYSTEM TEST SUMMARY ===');
            summary.push(`Timestamp: ${new Date().toISOString()}`);
            summary.push(`Platform: ${navigator.platform}`);
            summary.push(`Browser: ${navigator.userAgent.split(' ').slice(-2).join(' ')}`);
            summary.push('');
            
            // System Status
            summary.push('SYSTEM STATUS:');
            summary.push(`‚úì Gamification: ${window.Gamification ? 'LOADED' : 'NOT LOADED'}`);
            summary.push(`‚úì Points System: ${typeof window.awardPoints === 'function' ? 'AVAILABLE' : 'NOT AVAILABLE'}`);
            summary.push(`‚úì Level System: ${typeof window.getPlayerLevel === 'function' ? 'AVAILABLE' : 'NOT AVAILABLE'}`);
            summary.push(`‚úì Achievement System: ${typeof window.unlockAchievement === 'function' ? 'AVAILABLE' : 'NOT AVAILABLE'}`);
            summary.push('');
            
            // Test Results
            summary.push('TEST RESULTS:');
            Object.keys(testResults).forEach(testName => {
                summary.push(`\\n${testName.toUpperCase().replace(/_/g, ' ')}:`);
                testResults[testName].forEach(result => {
                    summary.push(`  ${result}`);
                });
            });
            
            // Error Summary
            const errors = debugLog.filter(log => log.type === 'ERROR');
            summary.push('\\nERROR SUMMARY:');
            if (errors.length === 0) {
                summary.push('  No errors detected');
            } else {
                errors.forEach(error => {
                    summary.push(`  ‚ùå ${error.message}`);
                });
            }
            
            summary.push('\\n=== END TEST SUMMARY ===');
            
            document.getElementById('test-results-output').value = summary.join('\\n');
        }

        function generateFullDebugData() {
            const data = {
                systemInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screenResolution: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    timestamp: new Date().toISOString()
                },
                testResults: testResults,
                performanceMetrics: performanceMetrics,
                debugLog: debugLog,
                gamificationData: localGamificationData,
                componentStatus: {
                    Gamification: !!window.Gamification,
                    awardPoints: typeof window.awardPoints === 'function',
                    addExperience: typeof window.addExperience === 'function',
                    unlockAchievement: typeof window.unlockAchievement === 'function',
                    availableMethods: window.Gamification ? Object.keys(window.Gamification) : []
                }
            };
            
            document.getElementById('debug-data-output').value = JSON.stringify(data, null, 2);
            console.log('Gamification Test Results:', data);
        }
    </script>
</body>
</html>