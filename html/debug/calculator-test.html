<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Calculator Test Suite | Debug</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/textbook.css">
    <link rel="stylesheet" href="../assets/css/callouts.css">
    
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .debug-section {
            margin: 40px 0;
            padding: 20px;
            border-left: 4px solid #28a745;
            background: #f8f9fa;
        }
        
        .test-container {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .error-log {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success-log {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #218838;
        }
        
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .component-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px;
        }
        
        .status-loaded { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        .calculator-input {
            width: 100px;
            padding: 5px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .test-result {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container">
            <h1>🧮 Financial Calculator Test Suite</h1>
            <p>Comprehensive testing and debugging for all financial calculator functionality</p>
        </div>
    </header>

    <main id="main-content" class="main-content">
        <div class="container">
            <div class="content-wrapper">
                <div class="main-content-area">
                    
                    <!-- Debug Information Panel -->
                    <div class="debug-panel">
                        <h2>🚨 Debug Information</h2>
                        <div id="system-info"></div>
                        <div id="component-status"></div>
                        <div id="error-console"></div>
                        
                        <h3>Quick Test Actions</h3>
                        <button class="test-button" onclick="runAllCalculatorTests()">Run All Tests</button>
                        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
                        <button class="test-button" onclick="exportDebugInfo()">Export Debug Info</button>
                        <button class="test-button" onclick="testCalculationAccuracy()">Test Calculation Accuracy</button>
                        <button class="test-button" onclick="testInputValidation()">Test Input Validation</button>
                        <button class="test-button" onclick="populateTestData()">Populate Test Data</button>
                        <button class="test-button" onclick="reinitializeCalculators()">Reinitialize Calculators</button>
                        <button class="test-button" onclick="debugCalculatorContainers()">Debug Containers</button>
                    </div>

                    <!-- Test Section 1: NPV Calculator -->
                    <div class="debug-section">
                        <h2>Test 1: NPV Calculator</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test Net Present Value calculations with dynamic cash flows<br>
                            <strong>Expected:</strong> Accurate NPV calculation, dynamic inputs, investment recommendations
                        </div>
                        
                        <div class="test-container">
                            <h3>NPV Calculator Component</h3>
                            <div class="npv-calculator-container" id="test-npv"></div>
                            
                            <div class="debug-panel">
                                <h4>Manual Test Data Entry:</h4>
                                <label>Initial Investment: $<input type="number" class="calculator-input" id="npv-initial" value="10000" onchange="updateNPVTest()"></label><br>
                                <label>Discount Rate: <input type="number" class="calculator-input" id="npv-rate" value="10" step="0.1" onchange="updateNPVTest()">%</label><br>
                                <label>Year 1 Cash Flow: $<input type="number" class="calculator-input" id="npv-year1" value="3000" onchange="updateNPVTest()"></label><br>
                                <label>Year 2 Cash Flow: $<input type="number" class="calculator-input" id="npv-year2" value="4000" onchange="updateNPVTest()"></label><br>
                                <label>Year 3 Cash Flow: $<input type="number" class="calculator-input" id="npv-year3" value="5000" onchange="updateNPVTest()"></label><br>
                                
                                <h4>Test Actions:</h4>
                                <button class="test-button" onclick="testNPVCalculations()">Test NPV Math</button>
                                <button class="test-button" onclick="testNPVDynamicInputs()">Test Dynamic Inputs</button>
                                <button class="test-button" onclick="testNPVEdgeCases()">Test Edge Cases</button>
                                <button class="test-button" onclick="validateNPVFormulas()">Validate Formulas</button>
                                
                                <div id="npv-test-results" class="test-result"></div>
                                <div id="npv-manual-calculation" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 2: Loan Calculator -->
                    <div class="debug-section">
                        <h2>Test 2: Loan Payment Calculator</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test loan payment calculations and amortization<br>
                            <strong>Expected:</strong> Monthly payments, total interest, payment breakdown visualization
                        </div>
                        
                        <div class="test-container">
                            <h3>Loan Calculator Component</h3>
                            <div class="loan-calculator-container" id="test-loan"></div>
                            
                            <div class="debug-panel">
                                <h4>Manual Test Data Entry:</h4>
                                <label>Loan Amount: $<input type="number" class="calculator-input" id="loan-principal" value="25000" onchange="updateLoanTest()"></label><br>
                                <label>Annual Rate: <input type="number" class="calculator-input" id="loan-rate" value="5.5" step="0.1" onchange="updateLoanTest()">%</label><br>
                                <label>Term (Years): <input type="number" class="calculator-input" id="loan-term" value="5" onchange="updateLoanTest()"></label><br>
                                
                                <h4>Test Actions:</h4>
                                <button class="test-button" onclick="testLoanCalculations()">Test Loan Math</button>
                                <button class="test-button" onclick="testLoanAmortization()">Test Amortization</button>
                                <button class="test-button" onclick="testLoanEdgeCases()">Test Edge Cases</button>
                                <button class="test-button" onclick="validateLoanFormulas()">Validate Formulas</button>
                                
                                <div id="loan-test-results" class="test-result"></div>
                                <div id="loan-manual-calculation" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Section 3: Break-Even Calculator -->
                    <div class="debug-section">
                        <h2>Test 3: Break-Even Calculator</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test break-even analysis calculations and scenarios<br>
                            <strong>Expected:</strong> Break-even units/revenue, contribution margin, profit/loss analysis
                        </div>
                        
                        <div class="test-container">
                            <h3>Break-Even Calculator Component</h3>
                            <div class="breakeven-calculator-container" id="test-breakeven"></div>
                            
                            <div class="debug-panel">
                                <h4>Manual Test Data Entry:</h4>
                                <label>Fixed Costs: $<input type="number" class="calculator-input" id="be-fixed" value="5000" onchange="updateBreakEvenTest()"></label><br>
                                <label>Variable Cost per Unit: $<input type="number" class="calculator-input" id="be-variable" value="15" step="0.01" onchange="updateBreakEvenTest()"></label><br>
                                <label>Selling Price per Unit: $<input type="number" class="calculator-input" id="be-price" value="25" step="0.01" onchange="updateBreakEvenTest()"></label><br>
                                <label>Target Units: <input type="number" class="calculator-input" id="be-target" value="600" onchange="updateBreakEvenTest()"></label><br>
                                
                                <h4>Test Actions:</h4>
                                <button class="test-button" onclick="testBreakEvenCalculations()">Test Break-Even Math</button>
                                <button class="test-button" onclick="testContributionMargin()">Test Contribution Margin</button>
                                <button class="test-button" onclick="testProfitLossAnalysis()">Test Profit/Loss Analysis</button>
                                <button class="test-button" onclick="validateBreakEvenFormulas()">Validate Formulas</button>
                                
                                <div id="breakeven-test-results" class="test-result"></div>
                                <div id="breakeven-manual-calculation" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Cross-Calculator Integration Tests -->
                    <div class="debug-section">
                        <h2>Test 4: Integration & Performance Tests</h2>
                        <div class="debug-info">
                            <strong>Purpose:</strong> Test multiple calculators together and performance metrics<br>
                            <strong>Expected:</strong> No conflicts, proper resource management, responsive UI
                        </div>
                        
                        <div class="test-container">
                            <h3>Multiple Calculator Instance Test</h3>
                            
                            <!-- Second set of calculators for conflict testing -->
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <h4>NPV Calculator #2</h4>
                                    <div class="npv-calculator-container" id="test-npv-2"></div>
                                </div>
                                <div style="flex: 1; min-width: 300px;">
                                    <h4>Loan Calculator #2</h4>
                                    <div class="loan-calculator-container" id="test-loan-2"></div>
                                </div>
                            </div>
                            
                            <div class="debug-panel">
                                <h4>Integration Test Actions:</h4>
                                <button class="test-button" onclick="testMultipleInstances()">Test Multiple Instances</button>
                                <button class="test-button" onclick="testCalculatorConflicts()">Test Conflicts</button>
                                <button class="test-button" onclick="measurePerformance()">Measure Performance</button>
                                <button class="test-button" onclick="testMemoryLeaks()">Test Memory Usage</button>
                                
                                <div id="integration-test-results" class="test-result"></div>
                                <div id="performance-metrics" class="test-result"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Comprehensive Testing Section -->
                    <div class="debug-section">
                        <h2>🧪 Comprehensive Test Results</h2>
                        <div id="comprehensive-results"></div>
                        
                        <div class="debug-panel">
                            <h3>Financial Formula Validation</h3>
                            <div id="formula-validation"></div>
                            
                            <h3>Accuracy Benchmarks</h3>
                            <div id="accuracy-benchmarks"></div>
                            
                            <h3>Input Validation Results</h3>
                            <div id="validation-results"></div>
                        </div>
                    </div>

                    <!-- Error Log Section -->
                    <div class="debug-section">
                        <h2>🐛 Error Log & Console Output</h2>
                        <div id="error-log" class="error-log">No errors logged yet...</div>
                        
                        <h3>Test Data Export</h3>
                        <textarea id="debug-export" rows="10" cols="100" readonly 
                                  placeholder="Debug information will appear here for copy/paste into chat"></textarea>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="../assets/js/gamification.js"></script>
    <script src="../assets/js/financial-calculators.js"></script>
    <script src="../assets/js/exercises.js"></script>
    
    <script>
        // Debug logging system
        let debugLog = [];
        let testResults = {};
        let performanceMetrics = {};
        
        // Override console methods to capture output
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };
        
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            logDebug('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            logDebug('ERROR', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            logDebug('WARN', args.join(' '));
        };
        
        function logDebug(type, message) {
            const timestamp = new Date().toISOString();
            debugLog.push({type, message, timestamp});
            updateErrorLog();
        }
        
        function updateErrorLog() {
            const errorDiv = document.getElementById('error-log');
            if (debugLog.length === 0) {
                errorDiv.textContent = 'No errors logged yet...';
                return;
            }
            
            errorDiv.innerHTML = debugLog.map(entry => 
                `[${entry.timestamp}] ${entry.type}: ${entry.message}`
            ).join('\n');
        }
        
        // System information collection
        function collectSystemInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenResolution: `${screen.width}x${screen.height}`,
                windowSize: `${window.innerWidth}x${window.innerHeight}`,
                memoryInfo: navigator.memory ? {
                    usedJSHeapSize: navigator.memory.usedJSHeapSize,
                    totalJSHeapSize: navigator.memory.totalJSHeapSize,
                    jsHeapSizeLimit: navigator.memory.jsHeapSizeLimit
                } : 'Not available',
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('system-info').innerHTML = `
                <h3>System Information</h3>
                <strong>Browser:</strong> ${info.userAgent}<br>
                <strong>Platform:</strong> ${info.platform}<br>
                <strong>Screen:</strong> ${info.screenResolution}<br>
                <strong>Window:</strong> ${info.windowSize}<br>
                <strong>Memory:</strong> ${JSON.stringify(info.memoryInfo)}<br>
                <strong>Test Time:</strong> ${info.timestamp}
            `;
            
            return info;
        }
        
        // Component status checking
        function checkComponentStatus() {
            const components = [
                {name: 'Financial Calculators Script', check: () => window.FinancialCalculators},
                {name: 'NPV Calculator Class', check: () => window.FinancialCalculators && window.FinancialCalculators.NPVCalculator},
                {name: 'Loan Calculator Class', check: () => window.FinancialCalculators && window.FinancialCalculators.LoanCalculator},
                {name: 'BreakEven Calculator Class', check: () => window.FinancialCalculators && window.FinancialCalculators.BreakEvenCalculator},
                {name: 'Initialize Function', check: () => window.FinancialCalculators && window.FinancialCalculators.initializeFinancialCalculators},
                {name: 'Gamification', check: () => window.Gamification}
            ];
            
            const statusDiv = document.getElementById('component-status');
            let statusHTML = '<h3>Component Status</h3>';
            
            components.forEach(comp => {
                const isLoaded = comp.check();
                const statusClass = isLoaded ? 'status-loaded' : 'status-error';
                const statusText = isLoaded ? 'LOADED' : 'ERROR';
                statusHTML += `<span class="component-status ${statusClass}">${comp.name}: ${statusText}</span>`;
            });
            
            // Check calculator containers
            const containers = [
                {name: 'NPV Container', selector: '.npv-calculator-container'},
                {name: 'Loan Container', selector: '.loan-calculator-container'},
                {name: 'BreakEven Container', selector: '.breakeven-calculator-container'}
            ];
            
            statusHTML += '<br><h4>Container Status</h4>';
            containers.forEach(cont => {
                const element = document.querySelector(cont.selector);
                const found = element !== null;
                const statusClass = found ? 'status-loaded' : 'status-error';
                const statusText = found ? 'FOUND' : 'MISSING';
                statusHTML += `<span class="component-status ${statusClass}">${cont.name}: ${statusText}</span>`;
                
                if (found) {
                    const hasCalculator = element.querySelector('.financial-calculator');
                    const initStatus = hasCalculator ? 'INITIALIZED' : 'NOT INITIALIZED';
                    const initClass = hasCalculator ? 'status-loaded' : 'status-error';
                    statusHTML += `<br><small><span class="component-status ${initClass}">&nbsp;&nbsp;${cont.name} ${initStatus}</span></small>`;
                }
            });
            
            statusDiv.innerHTML = statusHTML;
        }
        
        // NPV Calculator Tests
        function testNPVCalculations() {
            const results = [];
            const startTime = performance.now();
            
            try {
                // Manual NPV calculation for verification
                const initial = parseFloat(document.getElementById('npv-initial').value);
                const rate = parseFloat(document.getElementById('npv-rate').value) / 100;
                const cf1 = parseFloat(document.getElementById('npv-year1').value);
                const cf2 = parseFloat(document.getElementById('npv-year2').value);
                const cf3 = parseFloat(document.getElementById('npv-year3').value);
                
                const manualNPV = -initial + (cf1 / Math.pow(1 + rate, 1)) + 
                                           (cf2 / Math.pow(1 + rate, 2)) + 
                                           (cf3 / Math.pow(1 + rate, 3));
                
                document.getElementById('npv-manual-calculation').innerHTML = `
                    <strong>Manual NPV Calculation:</strong><br>
                    NPV = -${initial} + ${cf1}/(1+${rate})^1 + ${cf2}/(1+${rate})^2 + ${cf3}/(1+${rate})^3<br>
                    NPV = -${initial} + ${(cf1 / Math.pow(1 + rate, 1)).toFixed(2)} + ${(cf2 / Math.pow(1 + rate, 2)).toFixed(2)} + ${(cf3 / Math.pow(1 + rate, 3)).toFixed(2)}<br>
                    <strong>Expected NPV: $${manualNPV.toFixed(2)}</strong>
                `;
                
                results.push(`✓ Manual calculation completed: $${manualNPV.toFixed(2)}`);
                
                // Test if NPV calculator exists and functions
                const npvContainer = document.getElementById('test-npv');
                if (npvContainer) {
                    results.push('✓ NPV container found');
                    
                    // Test input fields existence
                    const inputs = npvContainer.querySelectorAll('input');
                    results.push(`✓ Found ${inputs.length} input fields`);
                    
                    // Test calculation display
                    const resultDisplay = npvContainer.querySelector('.npv-result, .result-display, .calculation-result');
                    if (resultDisplay) {
                        results.push('✓ Result display found');
                    } else {
                        results.push('✗ Result display not found');
                    }
                } else {
                    results.push('✗ NPV container not found');
                }
                
            } catch (error) {
                results.push(`✗ Error in NPV calculation: ${error.message}`);
                logDebug('ERROR', `NPV calculation test failed: ${error.message}`);
            }
            
            const endTime = performance.now();
            performanceMetrics.npv_test = endTime - startTime;
            
            document.getElementById('npv-test-results').innerHTML = results.join('<br>');
            testResults.npv_calculations = results;
        }
        
        function testLoanCalculations() {
            const results = [];
            const startTime = performance.now();
            
            try {
                // Manual loan payment calculation
                const principal = parseFloat(document.getElementById('loan-principal').value);
                const annualRate = parseFloat(document.getElementById('loan-rate').value) / 100;
                const years = parseFloat(document.getElementById('loan-term').value);
                
                const monthlyRate = annualRate / 12;
                const numPayments = years * 12;
                
                const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                                     (Math.pow(1 + monthlyRate, numPayments) - 1);
                
                const totalAmount = monthlyPayment * numPayments;
                const totalInterest = totalAmount - principal;
                
                document.getElementById('loan-manual-calculation').innerHTML = `
                    <strong>Manual Loan Calculation:</strong><br>
                    Principal: $${principal.toFixed(2)}<br>
                    Monthly Rate: ${(monthlyRate * 100).toFixed(4)}%<br>
                    Number of Payments: ${numPayments}<br>
                    <strong>Monthly Payment: $${monthlyPayment.toFixed(2)}</strong><br>
                    <strong>Total Interest: $${totalInterest.toFixed(2)}</strong><br>
                    <strong>Total Amount: $${totalAmount.toFixed(2)}</strong>
                `;
                
                results.push(`✓ Manual calculation completed: $${monthlyPayment.toFixed(2)}/month`);
                
                // Test loan calculator component
                const loanContainer = document.getElementById('test-loan');
                if (loanContainer) {
                    results.push('✓ Loan container found');
                    
                    const inputs = loanContainer.querySelectorAll('input');
                    results.push(`✓ Found ${inputs.length} input fields`);
                    
                    const resultDisplay = loanContainer.querySelector('.loan-result, .result-display, .calculation-result');
                    if (resultDisplay) {
                        results.push('✓ Result display found');
                    } else {
                        results.push('✗ Result display not found');
                    }
                } else {
                    results.push('✗ Loan container not found');
                }
                
            } catch (error) {
                results.push(`✗ Error in loan calculation: ${error.message}`);
                logDebug('ERROR', `Loan calculation test failed: ${error.message}`);
            }
            
            const endTime = performance.now();
            performanceMetrics.loan_test = endTime - startTime;
            
            document.getElementById('loan-test-results').innerHTML = results.join('<br>');
            testResults.loan_calculations = results;
        }
        
        function testBreakEvenCalculations() {
            const results = [];
            const startTime = performance.now();
            
            try {
                // Manual break-even calculation
                const fixedCosts = parseFloat(document.getElementById('be-fixed').value);
                const variableCost = parseFloat(document.getElementById('be-variable').value);
                const sellingPrice = parseFloat(document.getElementById('be-price').value);
                const targetUnits = parseFloat(document.getElementById('be-target').value);
                
                const contributionMargin = sellingPrice - variableCost;
                const contributionMarginRatio = contributionMargin / sellingPrice;
                const breakEvenUnits = fixedCosts / contributionMargin;
                const breakEvenRevenue = breakEvenUnits * sellingPrice;
                
                const targetRevenue = targetUnits * sellingPrice;
                const targetVariableCosts = targetUnits * variableCost;
                const targetProfit = targetRevenue - fixedCosts - targetVariableCosts;
                
                document.getElementById('breakeven-manual-calculation').innerHTML = `
                    <strong>Manual Break-Even Calculation:</strong><br>
                    Contribution Margin: $${sellingPrice} - $${variableCost} = $${contributionMargin.toFixed(2)}<br>
                    Contribution Margin Ratio: ${(contributionMarginRatio * 100).toFixed(1)}%<br>
                    <strong>Break-Even Units: ${breakEvenUnits.toFixed(0)} units</strong><br>
                    <strong>Break-Even Revenue: $${breakEvenRevenue.toFixed(2)}</strong><br>
                    <br>
                    <strong>Target Analysis (${targetUnits} units):</strong><br>
                    Revenue: $${targetRevenue.toFixed(2)}<br>
                    Variable Costs: $${targetVariableCosts.toFixed(2)}<br>
                    Fixed Costs: $${fixedCosts.toFixed(2)}<br>
                    <strong>Profit/Loss: $${targetProfit.toFixed(2)}</strong>
                `;
                
                results.push(`✓ Manual calculation completed: ${breakEvenUnits.toFixed(0)} units`);
                
                // Test break-even calculator component
                const beContainer = document.getElementById('test-breakeven');
                if (beContainer) {
                    results.push('✓ Break-even container found');
                    
                    const inputs = beContainer.querySelectorAll('input');
                    results.push(`✓ Found ${inputs.length} input fields`);
                    
                    const resultDisplay = beContainer.querySelector('.breakeven-result, .result-display, .calculation-result');
                    if (resultDisplay) {
                        results.push('✓ Result display found');
                    } else {
                        results.push('✗ Result display not found');
                    }
                } else {
                    results.push('✗ Break-even container not found');
                }
                
            } catch (error) {
                results.push(`✗ Error in break-even calculation: ${error.message}`);
                logDebug('ERROR', `Break-even calculation test failed: ${error.message}`);
            }
            
            const endTime = performance.now();
            performanceMetrics.breakeven_test = endTime - startTime;
            
            document.getElementById('breakeven-test-results').innerHTML = results.join('<br>');
            testResults.breakeven_calculations = results;
        }
        
        // Comprehensive test runner
        function runAllCalculatorTests() {
            logDebug('LOG', 'Starting comprehensive calculator test suite...');
            
            setTimeout(() => testNPVCalculations(), 100);
            setTimeout(() => testLoanCalculations(), 200);
            setTimeout(() => testBreakEvenCalculations(), 300);
            setTimeout(() => testMultipleInstances(), 400);
            setTimeout(() => generateComprehensiveReport(), 600);
        }
        
        function testMultipleInstances() {
            const results = [];
            
            try {
                const containers = [
                    document.getElementById('test-npv'),
                    document.getElementById('test-loan'),
                    document.getElementById('test-breakeven'),
                    document.getElementById('test-npv-2'),
                    document.getElementById('test-loan-2')
                ];
                
                const foundContainers = containers.filter(c => c !== null);
                results.push(`✓ Found ${foundContainers.length} calculator containers`);
                
                // Test for conflicts or interference
                if (foundContainers.length > 1) {
                    results.push('✓ Multiple instances can coexist');
                } else {
                    results.push('✗ Multiple instances not properly loaded');
                }
                
            } catch (error) {
                results.push(`✗ Error testing multiple instances: ${error.message}`);
            }
            
            document.getElementById('integration-test-results').innerHTML = results.join('<br>');
            testResults.multiple_instances = results;
        }
        
        function generateComprehensiveReport() {
            const results = document.getElementById('comprehensive-results');
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => 
                result.some(r => r.startsWith('✓'))
            ).length;
            
            const performanceHTML = Object.entries(performanceMetrics)
                .map(([test, time]) => `${test}: ${time.toFixed(2)}ms`)
                .join('<br>');
            
            results.innerHTML = `
                <div class="success-log">
                    <h3>Calculator Test Summary</h3>
                    <strong>Total Test Suites:</strong> ${totalTests}<br>
                    <strong>Passed:</strong> ${passedTests}<br>
                    <strong>Failed:</strong> ${totalTests - passedTests}<br>
                    <strong>Success Rate:</strong> ${totalTests > 0 ? Math.round((passedTests/totalTests)*100) : 0}%
                </div>
            `;
            
            document.getElementById('performance-metrics').innerHTML = `
                <h4>Performance Metrics:</h4>
                ${performanceHTML}
            `;
        }
        
        function exportDebugInfo() {
            const exportData = {
                systemInfo: collectSystemInfo(),
                testResults: testResults,
                performanceMetrics: performanceMetrics,
                debugLog: debugLog,
                timestamp: new Date().toISOString(),
                calculatorStates: {
                    npv: {
                        initial: document.getElementById('npv-initial').value,
                        rate: document.getElementById('npv-rate').value,
                        year1: document.getElementById('npv-year1').value,
                        year2: document.getElementById('npv-year2').value,
                        year3: document.getElementById('npv-year3').value
                    },
                    loan: {
                        principal: document.getElementById('loan-principal').value,
                        rate: document.getElementById('loan-rate').value,
                        term: document.getElementById('loan-term').value
                    },
                    breakeven: {
                        fixed: document.getElementById('be-fixed').value,
                        variable: document.getElementById('be-variable').value,
                        price: document.getElementById('be-price').value,
                        target: document.getElementById('be-target').value
                    }
                }
            };
            
            document.getElementById('debug-export').value = JSON.stringify(exportData, null, 2);
        }
        
        function clearLogs() {
            debugLog = [];
            testResults = {};
            performanceMetrics = {};
            updateErrorLog();
            document.getElementById('debug-export').value = '';
            
            // Clear all test result divs
            ['npv-test-results', 'loan-test-results', 'breakeven-test-results', 
             'integration-test-results', 'comprehensive-results', 'performance-metrics'].forEach(id => {
                const div = document.getElementById(id);
                if (div) div.innerHTML = '';
            });
        }
        
        function populateTestData() {
            // Set realistic test values
            document.getElementById('npv-initial').value = 50000;
            document.getElementById('npv-rate').value = 12;
            document.getElementById('npv-year1').value = 15000;
            document.getElementById('npv-year2').value = 20000;
            document.getElementById('npv-year3').value = 25000;
            
            document.getElementById('loan-principal').value = 100000;
            document.getElementById('loan-rate').value = 6.5;
            document.getElementById('loan-term').value = 10;
            
            document.getElementById('be-fixed').value = 8000;
            document.getElementById('be-variable').value = 12;
            document.getElementById('be-price').value = 35;
            document.getElementById('be-target').value = 500;
            
            logDebug('LOG', 'Test data populated with realistic business values');
        }
        
        // Update functions for real-time testing
        function updateNPVTest() {
            testNPVCalculations();
        }
        
        function updateLoanTest() {
            testLoanCalculations();
        }
        
        function updateBreakEvenTest() {
            testBreakEvenCalculations();
        }
        
        // Additional test functions
        function testNPVDynamicInputs() { logDebug('LOG', 'Testing NPV dynamic inputs...'); }
        function testNPVEdgeCases() { logDebug('LOG', 'Testing NPV edge cases...'); }
        function validateNPVFormulas() { logDebug('LOG', 'Validating NPV formulas...'); }
        function testLoanAmortization() { logDebug('LOG', 'Testing loan amortization...'); }
        function testLoanEdgeCases() { logDebug('LOG', 'Testing loan edge cases...'); }
        function validateLoanFormulas() { logDebug('LOG', 'Validating loan formulas...'); }
        function testContributionMargin() { logDebug('LOG', 'Testing contribution margin...'); }
        function testProfitLossAnalysis() { logDebug('LOG', 'Testing profit/loss analysis...'); }
        function validateBreakEvenFormulas() { logDebug('LOG', 'Validating break-even formulas...'); }
        function testCalculatorConflicts() { logDebug('LOG', 'Testing calculator conflicts...'); }
        function measurePerformance() { logDebug('LOG', 'Measuring performance...'); }
        function testMemoryLeaks() { logDebug('LOG', 'Testing memory leaks...'); }
        function testCalculationAccuracy() { logDebug('LOG', 'Testing calculation accuracy...'); }
        function testInputValidation() { logDebug('LOG', 'Testing input validation...'); }
        
        // Additional debug functions
        function reinitializeCalculators() {
            logDebug('LOG', 'Manually reinitializing calculators...');
            if (window.FinancialCalculators && window.FinancialCalculators.initializeFinancialCalculators) {
                try {
                    window.FinancialCalculators.initializeFinancialCalculators();
                    logDebug('LOG', 'Reinitialization completed');
                    checkComponentStatus();
                } catch (error) {
                    logDebug('ERROR', `Reinitialization failed: ${error.message}`);
                }
            } else {
                logDebug('ERROR', 'FinancialCalculators.initializeFinancialCalculators not available');
            }
        }
        
        function debugCalculatorContainers() {
            logDebug('LOG', 'Debugging calculator containers...');
            const results = [];
            
            // Check all potential container selectors
            const selectors = ['.npv-calculator-container', '.loan-calculator-container', '.breakeven-calculator-container'];
            
            selectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                results.push(`${selector}: found ${elements.length} elements`);
                
                elements.forEach((el, index) => {
                    results.push(`  Element ${index}: id="${el.id}", classes="${el.className}"`);
                    results.push(`  Inner HTML preview: ${el.innerHTML.substring(0, 100)}...`);
                });
            });
            
            // Check if containers have been initialized
            const allContainers = document.querySelectorAll('.npv-calculator-container, .loan-calculator-container, .breakeven-calculator-container');
            results.push(`Total calculator containers: ${allContainers.length}`);
            
            allContainers.forEach((container, index) => {
                const hasFinancialCalc = container.querySelector('.financial-calculator');
                const hasInputs = container.querySelector('input');
                results.push(`Container ${index}: initialized=${!!hasFinancialCalc}, hasInputs=${!!hasInputs}`);
            });
            
            // Display results
            const debugInfo = results.join('\n');
            logDebug('LOG', `Container debug results:\n${debugInfo}`);
            
            // Also show in the error log
            document.getElementById('error-log').innerHTML += '\n\n=== CONTAINER DEBUG ===\n' + debugInfo;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('LOG', 'Calculator debug page loaded, initializing...');
            collectSystemInfo();
            
            setTimeout(() => {
                checkComponentStatus();
                populateTestData();
                debugCalculatorContainers(); // Auto-run container debug
                logDebug('LOG', 'Initial setup completed');
            }, 1000);
        });
    </script>
</body>
</html>